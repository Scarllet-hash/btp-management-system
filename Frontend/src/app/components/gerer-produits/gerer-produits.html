<div class="gerer-produits-container">
  <div class="header">
    <h2>Products</h2>
    <div class="header-actions">
      <button class="import-export-btn">
        <i class="icon-import-export"></i>
        IMPORTER / EXPORTER
      </button>
    </div>
  </div>
  
  <div class="filters-section">
    <div class="status-filters">
      <span class="status-label">STATUT:</span>
      <div class="filter-buttons">
        <button class="filter-btn" [class.active]="selectedStatus === 'tous'" (click)="filterByStatus('tous')">Tous</button>
        <button class="filter-btn" [class.active]="selectedStatus === 'attente'" (click)="filterByStatus('attente')">En attente de v√©rification</button>
        <button class="filter-btn" [class.active]="selectedStatus === 'pas-pret'" (click)="filterByStatus('pas-pret')">Pas pr√™t pour la v√©rification</button>
        <button class="filter-btn" [class.active]="selectedStatus === 'approuve'" (click)="filterByStatus('approuve')">Approuv√©</button>
        <button class="filter-btn" [class.active]="selectedStatus === 'rejete'" (click)="filterByStatus('rejete')">Rejet√©</button>
        <button class="filter-btn" [class.active]="selectedStatus === 'actif'" (click)="filterByStatus('actif')">Actif</button>
        <button class="filter-btn" [class.active]="selectedStatus === 'inactif'" (click)="filterByStatus('inactif')">Inactif</button>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="loading-text">Chargement des produits...</p>
  </div>

  <div class="table-container" *ngIf="!isLoading">
    <table class="products-table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Nom</th>
          <th>Description</th>
          <th>Prix</th>
          <th>Quantit√© <i class="info-icon">‚ìò</i></th>
          <th>Visible</th>
          <th>√âtat</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="filteredProducts.length === 0">
          <td colspan="9" class="no-results">Pas de r√©sultats trouv√©s !</td>
        </tr>
        
        <ng-container *ngFor="let product of filteredProducts">
          <!-- Ligne normale -->
          <tr *ngIf="!isEditing(product)">
            <td>
              <div class="image-container">
                <div *ngIf="getImageCount(product) > 0">
                  <img [src]="getProductImage(product, getCurrentImageIndex(product.id!))" 
                       [alt]="product.nom" 
                       class="product-image" />
                  <div class="image-navigation" *ngIf="hasMultipleImages(product)">
                    <button class="nav-btn prev-btn" (click)="previousImage(product, $event)" title="Image pr√©c√©dente">‚óÄ</button>
                    <span class="image-counter">{{ getCurrentImageIndex(product.id!) + 1 }} / {{ getImageCount(product) }}</span>
                    <button class="nav-btn next-btn" (click)="nextImage(product, $event)" title="Image suivante">‚ñ∂</button>
                  </div>
                </div>
                <div class="no-image-indicator" *ngIf="getImageCount(product) === 0">üì∑ Pas d'image</div>
              </div>
            </td>
            <td>{{ product.nom }}</td>
            <td class="description-cell">
              <div class="description-preview">{{ product.description }}</div>
            </td>
            <td>{{ product.prix | currency:'EUR':'symbol':'1.2-2' }}</td>
            <td>
              <span [ngClass]="getStockStatus(product.quantite).class">
                {{ product.quantite }}
              </span>
            </td>
            <td>
              <span *ngIf="product.quantite > 0" class="status-badge visible">Visible</span>
              <span *ngIf="product.quantite === 0" class="status-badge invisible">Invisible</span>
            </td>
            <td>
              <span class="etat-badge" [ngClass]="getEtatClass(product.etat)">
                {{ getEtatLabel(product.etat) }}
              </span>
            </td>
            <td>
              <div class="actions">
                <button class="action-btn edit-btn" (click)="editProduct(product)" title="Modifier">‚úèÔ∏è</button>
                <button class="action-btn delete-btn" (click)="deleteProduct(product)" title="Supprimer">üóëÔ∏è</button>
              </div>
            </td>
          </tr>

          <!-- Ligne d'√©dition √©tendue -->
          <tr *ngIf="isEditing(product)" class="editing-row">
            <td colspan="9" class="editing-cell">
              <div class="edit-container">
                <div class="edit-header">
                  <h3>√âdition: {{ product.nom }}</h3>
                  <div class="edit-actions">
                    <button class="action-btn save-btn-large" (click)="saveProduct()">
                      ‚úÖ Enregistrer
                    </button>
                    <button class="action-btn cancel-btn-large" (click)="cancelEdit()">
                      ‚ùå Annuler
                    </button>
                  </div>
                </div>

                <div class="edit-grid">
                  <!-- Section informations de base -->
                  <div class="edit-section">
                    <h4>Informations de base</h4>
                    <div class="form-group">
                      <label>Nom du produit</label>
                      <input type="text" 
                             [(ngModel)]="editingProduct!.nom" 
                             class="form-control" />
                    </div>

                    <div class="form-group">
                      <label>Description</label>
                      <textarea 
                        [(ngModel)]="editingProduct!.description" 
                        class="form-control"
                        rows="4"
                        placeholder="D√©crivez votre produit..."></textarea>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Prix (MAD)</label>
                        <input type="number" 
                               [(ngModel)]="editingProduct!.prix" 
                               class="form-control" 
                               step="0.01" />
                      </div>

                      <div class="form-group">
                        <label>Prix de vente (calcul√©)</label>
                        <input type="text" 
                               [value]="(editingProduct!.prix * 1.2 | currency:'EUR':'symbol':'1.2-2')" 
                               class="form-control" 
                               disabled />
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group">
                        <label>Quantit√©</label>
                        <input type="number" 
                               [(ngModel)]="editingProduct!.quantite" 
                               class="form-control" />
                      </div>

                      <div class="form-group">
                        <label>√âtat</label>
                        <select [(ngModel)]="editingProduct!.etat" class="form-control">
                          <option *ngFor="let e of etats" [value]="e">{{ getEtatLabel(e) }}</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Section images -->
                  <div class="edit-section images-section">
                    <h4>Images du produit</h4>
                    <p class="image-info">
                      L'image doit √™tre comprise entre 500 √ó 500 et 2 000 √ó 2 000 pixels. 
                      Les fonds blancs sont recommand√©s. Taille maximale 2 Mo.
                    </p>
                    
                    <div class="image-upload-grid">
                      <!-- Image principale -->
                      <div class="image-upload main-image" 
                           [class.has-image]="hasSelectedImage(product.id, 0)">
                        <input type="file" 
                               accept="image/*" 
                               (change)="onImageSelect($event, 0)"
                               [id]="'edit-image-' + product.id + '-0'"
                               style="display: none;">
                        <label [for]="'edit-image-' + product.id + '-0'" class="upload-label">
                          <div *ngIf="!hasSelectedImage(product.id, 0)" class="upload-placeholder">
                            <span class="plus-icon">+</span>
                            <span class="upload-text">Image principale</span>
                          </div>
                          <img *ngIf="hasSelectedImage(product.id, 0)" 
                               [src]="getSelectedImage(product.id, 0)" 
                               class="uploaded-image">
                        </label>
                        <button *ngIf="hasSelectedImage(product.id, 0)" 
                                class="remove-image" 
                                (click)="removeImage(0)">√ó</button>
                      </div>

                      <!-- Images secondaires -->
                      <div class="image-upload" 
                           *ngFor="let idx of [1,2,3,4,5,6]"
                           [class.has-image]="hasSelectedImage(product.id, idx)">
                        <input type="file" 
                               accept="image/*" 
                               (change)="onImageSelect($event, idx)"
                               [id]="'edit-image-' + product.id + '-' + idx"
                               style="display: none;">
                        <label [for]="'edit-image-' + product.id + '-' + idx" class="upload-label">
                          <div *ngIf="!hasSelectedImage(product.id, idx)" class="upload-placeholder">
                            <span class="plus-icon">+</span>
                            <span class="upload-text">Image {{ idx + 1 }}</span>
                          </div>
                          <img *ngIf="hasSelectedImage(product.id, idx)" 
                               [src]="getSelectedImage(product.id, idx)" 
                               class="uploaded-image">
                        </label>
                        <button *ngIf="hasSelectedImage(product.id, idx)" 
                                class="remove-image" 
                                (click)="removeImage(idx)">√ó</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>